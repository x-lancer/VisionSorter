# 系统依赖验证指南

## 一、Windows 上 Visual C++ 运行时的情况

### 1. Windows 是否默认有 C++ 运行时？

**答案：不一定，取决于 Windows 版本和安装的软件**

- **Windows 10/11 较新版本**：通常已预装部分 Visual C++ Redistributable（2015-2022）
- **Windows 7/8 或较旧版本**：可能没有或版本不完整
- **全新安装的 Windows**：通常只有基础系统库，可能缺少某些版本的 C++ 运行时

### 2. OpenCV 的依赖

OpenCV 通常依赖：
- **Visual C++ 2015-2022 Redistributable** (最常见)
- 某些情况下需要 **Visual C++ 2013 Redistributable**
- **Universal C Runtime** (Windows 10+ 通常自带)

## 二、验证方法

### 方法1：使用检查脚本（推荐）

运行提供的检查脚本：

```bash
python scripts/check_dependencies.py
```

或者在打包后的 exe 环境中运行（如果打包时包含了这个脚本）。

### 方法2：使用 Dependency Walker（详细分析）

1. **下载 Dependency Walker**
   - 官网：http://www.dependencywalker.com/
   - 或使用替代工具：Dependencies (https://github.com/lucasg/Dependencies)

2. **分析 exe 文件**
   - 打开 Dependency Walker
   - 加载你的 `LabClassificationService.exe`
   - 查看所有依赖的 DLL
   - 红色标记表示缺失的 DLL

3. **检查关键 DLL**
   - `MSVCR*.dll` - Visual C++ Runtime
   - `VCRUNTIME*.dll` - Visual C++ Runtime
   - `MSVCP*.dll` - Visual C++ Runtime
   - `api-ms-win-crt-*.dll` - Universal C Runtime

### 方法3：在干净系统测试（最可靠）

1. **创建干净的测试环境**
   - 使用虚拟机（VMware/VirtualBox）
   - 或使用 Windows Sandbox（Windows 10/11 Pro）
   - 安装全新的 Windows（不安装任何开发工具）

2. **测试步骤**
   ```
   1. 在干净系统中运行 exe
   2. 观察是否有错误提示
   3. 常见错误：
      - "缺少 MSVCR140.dll"
      - "无法启动此应用程序，因为计算机中丢失 VCRUNTIME140.dll"
      - "应用程序无法正常启动(0xc000007b)"
   ```

3. **如果出现 DLL 缺失错误**
   - 记录缺失的 DLL 名称
   - 安装对应的 Visual C++ Redistributable

## 三、解决方案

### 方案1：在安装包中包含 Redistributable（推荐）

创建安装包时，包含 Visual C++ Redistributable 安装程序：

**下载地址：**
- Visual C++ 2015-2022 Redistributable (x64): https://aka.ms/vs/17/release/vc_redist.x64.exe
- Visual C++ 2015-2022 Redistributable (x86): https://aka.ms/vs/17/release/vc_redist.x86.exe

**使用 Inno Setup 或 NSIS 创建安装程序：**
```inno
[Files]
Source: "vc_redist.x64.exe"; DestDir: "{tmp}"; Flags: deleteafterinstall

[Run]
Filename: "{tmp}\vc_redist.x64.exe"; Parameters: "/quiet /norestart"; StatusMsg: "正在安装 Visual C++ 运行时..."
```

### 方案2：在 README 中说明

如果不想自动安装，可以在使用说明中告知用户：

```
系统要求：
- Windows 7 或更高版本
- 如果运行时提示缺少 DLL，请安装：
  Visual C++ Redistributable for Visual Studio 2015-2022
  下载地址：https://aka.ms/vs/17/release/vc_redist.x64.exe
```

### 方案3：使用静态链接（高级，不推荐）

编译时使用静态链接，但这需要：
- 重新编译 OpenCV（复杂）
- 可能违反某些库的许可证
- 文件体积会更大

## 四、快速验证清单

✅ **在干净系统测试前，先检查：**

1. [ ] 运行 `check_dependencies.py` 查看依赖
2. [ ] 使用 Dependency Walker 分析 exe
3. [ ] 在虚拟机中测试（全新 Windows）
4. [ ] 检查是否有 DLL 缺失错误
5. [ ] 如果缺失，记录缺失的 DLL 名称
6. [ ] 安装对应的 Redistributable 后再次测试

## 五、常见错误和解决方案

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `缺少 MSVCR140.dll` | Visual C++ 2015-2022 运行时缺失 | 安装 VC++ 2015-2022 Redistributable |
| `缺少 MSVCR120.dll` | Visual C++ 2013 运行时缺失 | 安装 VC++ 2013 Redistributable |
| `无法启动此应用程序(0xc000007b)` | 通常是 32/64 位不匹配或运行时缺失 | 检查系统架构，安装对应版本的运行时 |
| `api-ms-win-crt-*.dll 缺失` | Universal C Runtime 缺失 | Windows 10+ 通常自带，Windows 7 需要安装更新 |

## 六、推荐的最终方案

**最佳实践：**

1. **打包时**：使用 PyInstaller 的 `--onefile` 打包所有 Python 依赖
2. **分发时**：提供两个文件
   - `LabClassificationService.exe` - 主程序
   - `vc_redist.x64.exe` - Visual C++ 运行时（可选，如果用户需要）
3. **文档中**：说明系统要求和可能的依赖问题
4. **测试**：在干净环境中验证

这样用户即使没有 Python 和 Visual C++ 运行时，也能通过简单安装运行库来使用你的程序。

