# 前后端打包部署指南

## 一、前端打包方案

### 1. 构建生产版本

前端使用 Vite 构建，已配置好构建脚本：

```bash
cd frontend
npm install          # 安装依赖（如果还没安装）
npm run build        # 构建生产版本
```

构建完成后，生成的文件在 `frontend/dist/` 目录中。

### 2. 前端部署选项

**选项A：静态文件服务器（推荐用于本地部署）**
- 将 `dist/` 目录内容复制到任何 HTTP 服务器
- 后端 API 和前端需要配置 CORS 或使用反向代理

**选项B：集成到后端服务（推荐用于单一部署）**
- Python 后端可以同时提供静态文件和 API
- 使用 FastAPI 的 `StaticFiles` 来托管前端文件

## 二、Python 后端打包方案

### 方案1：可执行文件打包（推荐，适合 Windows）

使用 **PyInstaller** 打包成独立的可执行文件：

```bash
# 1. 安装 PyInstaller
pip install pyinstaller

# 2. 创建打包脚本
# 在项目根目录创建 build_exe.bat (Windows) 或 build_exe.sh (Linux/Mac)

# 3. 打包
pyinstaller --name=LabClassificationService ^
    --onefile ^
    --add-data "service;service" ^
    --hidden-import=uvicorn ^
    --hidden-import=fastapi ^
    --hidden-import=sklearn ^
    --hidden-import=scipy ^
    --hidden-import=skimage ^
    --hidden-import=cv2 ^
    service/lab_service.py
```

**优点**：
- 生成单个 `.exe` 文件（Windows）或可执行文件（Linux/Mac）
- 无需用户安装 Python
- 包含所有依赖

**缺点**：
- 文件较大（可能 100-200MB）
- 首次启动可能较慢

### 方案2：Docker 容器化（推荐，跨平台）

创建 Dockerfile：

```dockerfile
FROM python:3.10-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY service/ ./service/

# 复制前端构建文件
COPY frontend/dist/ ./frontend/dist/

# 暴露端口
EXPOSE 8000

# 启动服务
CMD ["python", "-m", "uvicorn", "service.lab_service:app", "--host", "0.0.0.0", "--port", "8000"]
```

构建和使用：
```bash
docker build -t lab-classification-service .
docker run -p 8000:8000 lab-classification-service
```

**优点**：
- 跨平台，环境一致
- 易于部署和分发
- 隔离性好

**缺点**：
- 用户需要安装 Docker

### 方案3：Python 包 + 启动脚本

创建 `setup.py`：

```python
from setuptools import setup, find_packages

setup(
    name="lab-classification-service",
    version="1.0.0",
    packages=find_packages(),
    install_requires=[
        "fastapi",
        "uvicorn",
        "opencv-python",
        "numpy",
        "scikit-learn",
        "scipy",
        "scikit-image",
    ],
    entry_points={
        "console_scripts": [
            "lab-service=service.lab_service:main",
        ],
    },
)
```

然后打包：
```bash
python setup.py bdist_wheel
# 或
pip install build
python -m build
```

**优点**：
- 标准 Python 分发方式
- 可以安装到系统 Python 环境

**缺点**：
- 需要用户有 Python 环境

## 三、推荐方案：一体化部署

### 方案A：FastAPI 集成前端静态文件（最简单）

修改后端代码，同时提供 API 和前端静态文件：

```python
# 在 lab_service.py 末尾添加
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse

# ... 现有代码 ...

# 挂载前端静态文件（开发环境）
if os.path.exists("frontend/dist"):
    app.mount("/static", StaticFiles(directory="frontend/dist"), name="static")
    
    @app.get("/")
    async def read_root():
        return FileResponse("frontend/dist/index.html")
```

然后使用 PyInstaller 打包整个应用。

### 方案B：Docker + 前端构建集成（推荐用于生产）

在 Dockerfile 中添加前端构建步骤：

```dockerfile
# 多阶段构建
# 阶段1：构建前端
FROM node:18 AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install
COPY frontend/ ./
RUN npm run build

# 阶段2：Python 后端
FROM python:3.10-slim
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 复制并安装 Python 依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制后端代码
COPY service/ ./service/

# 从前端构建阶段复制构建结果
COPY --from=frontend-builder /app/frontend/dist ./frontend/dist

# 启动命令
CMD ["python", "-m", "uvicorn", "service.lab_service:app", "--host", "0.0.0.0", "--port", "8000"]
```

## 四、打包脚本示例

### Windows 批处理脚本（build.bat）

```batch
@echo off
echo 开始打包应用...

echo [1/3] 构建前端...
cd frontend
call npm install
call npm run build
cd ..

echo [2/3] 检查 Python 依赖...
pip install -r requirements.txt
pip install pyinstaller

echo [3/3] 打包后端...
pyinstaller --name=LabClassificationService ^
    --onefile ^
    --add-data "service;service" ^
    --add-data "frontend/dist;frontend/dist" ^
    --hidden-import=uvicorn ^
    --hidden-import=fastapi ^
    --collect-all=sklearn ^
    service/lab_service.py

echo 打包完成！可执行文件在 dist/ 目录
pause
```

### Linux/Mac Shell 脚本（build.sh）

```bash
#!/bin/bash
echo "开始打包应用..."

echo "[1/3] 构建前端..."
cd frontend
npm install
npm run build
cd ..

echo "[2/3] 检查 Python 依赖..."
pip install -r requirements.txt
pip install pyinstaller

echo "[3/3] 打包后端..."
pyinstaller --name=LabClassificationService \
    --onefile \
    --add-data "service:service" \
    --add-data "frontend/dist:frontend/dist" \
    --hidden-import=uvicorn \
    --hidden-import=fastapi \
    --collect-all=sklearn \
    service/lab_service.py

echo "打包完成！可执行文件在 dist/ 目录"
```

## 五、分发建议

### 对于技术用户
- **推荐**：Docker 镜像或 Python 包（`setup.py`）
- 提供 `README.md` 说明安装步骤

### 对于非技术用户
- **推荐**：PyInstaller 打包的 `.exe` 文件（Windows）
- 提供一键启动脚本
- 打包成安装程序（使用 Inno Setup 或 NSIS）

### 混合方案
- 提供 Docker 镜像（适合有 Docker 的用户）
- 同时提供可执行文件（适合没有 Docker 的用户）

## 六、注意事项

1. **路径问题**：打包后路径可能变化，需要处理相对路径
2. **依赖大小**：OpenCV、sklearn 等库较大，考虑使用 `--exclude-module` 排除不需要的模块
3. **跨平台**：Windows、Linux、macOS 需要分别打包
4. **许可证**：确保所有依赖的许可证兼容
5. **测试**：在干净环境中测试打包后的程序

## 七、快速开始示例

最简单的方案（适合快速分发）：

```bash
# 1. 构建前端
cd frontend && npm run build && cd ..

# 2. 修改后端以集成前端（见方案A）

# 3. 使用 PyInstaller 打包
pip install pyinstaller
pyinstaller --onefile --add-data "service;service" --add-data "frontend/dist;frontend/dist" service/lab_service.py

# 4. 分发 dist/LabClassificationService.exe（或对应平台的可执行文件）
```

