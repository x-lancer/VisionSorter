# 珠子颜色视觉分选系统 - 可行性分析报告

**文档日期**: 2026年1月13日  
**版本**: v1.0  
**适用对象**: 技术决策层 / 项目管理层

---

## 1. 项目背景与目标

本方案旨在解决**“未知类别数量”**的珠子流水线颜色分类问题。系统需在物料流经管道时实时拍照，依据视觉特征自动判断其颜色类别。若遇到全新颜色，系统需具备“自适应发现”能力，建立新分类。

---

## 2. 核心技术方案：增量式 LAB 聚类 (Leader Algorithm)

### 2.1 方案原理
采用 **Static Leader Algorithm (静态基准增量聚类)** 算法，结合 **CIELAB 颜色空间**。
-   **LAB 空间**: 使用 $\Delta E$ (欧氏距离) 作为相似度度量，符合人眼对颜色差异的感知（比 RGB 更准确）。
-   **首样基准 (First-Bead-Anchor)**: 每个类别的中心特征由**该类别建立时的第一颗珠子**唯一定义，且后续**不再变动**。
-   **增量判定**: 新珠子与已有类别的“首样基准”对比。若差值 < 阈值，则归入该类；若与所有基准的差值均 > 阈值，则建立新类别。

### 2.2 业务流程图

```mermaid
graph TD
    Start([系统启动]) --> Calib{是否已校准?};
    
    %% 校准流程
    Calib -- No --> Hint[提示: 放置白卡];
    Hint --> CaptureCal[拍摄白平横校准卡];
    CaptureCal --> SetGain[计算 RGB 增益系数];
    SetGain --> CalibDone[进入作业模式];
    
    %% 作业流程
    Calib -- Yes --> Wait[等待触发];
    Wait --> Photo[拍摄珠子图片];
    Photo --> Process[图像预处理 & 白平衡修正];
    Process --> Feat[特征提取: LAB均值 (中心加权)];
    
    Feat --> CheckEmpty{类别库为空?};
    CheckEmpty -- Yes --> NewClass[创建 第1类 (以当前珠子为基准)];
    
    CheckEmpty -- No --> CalcDist[计算与现有 N 个基准的色差];
    CalcDist --> FindMin[找到最小色差 Dist_min];
    
    FindMin --> Threshold{Dist_min < 阈值?};
    Threshold -- Yes (相似) --> Match[归入旧类别];
    
    Threshold -- No (差异大) --> Limit{类别数已满?};
    Limit -- No --> NewClass2[创建新类别 (建立新基准)];
    Limit -- Yes --> Exception[归入 '异常/待确认' 口];
```

### 2.3 关键算法逻辑 (伪代码)

```python
class SystemLogic:
    # ... (初始化代码不变)

    def process_image(self, raw_image):
        # 1. 白平衡修正
        img = self.apply_white_balance(raw_image, self.gain)
        
        # 2. 提取特征
        lab_vector = self.extract_center_weighted_lab(img)
        
        # 3. 寻找最近的 已知基准 (Fixed Anchors)
        min_dist = infinity
        best_id = -1
        for cid, anchor_vector in self.clusters.items():
            dist = distance(lab_vector, anchor_vector)
            if dist < min_dist:
                min_dist = dist
                best_id = cid
        
        # 4. 决策
        if best_id != -1 and min_dist < self.THRESHOLD:
            # 命中已知类别 -> 直接归类 (注意：不更新中心，保持首样标准)
            return best_id
            
        elif len(self.clusters) < MAX_PORTS:
            # 发现新颜色 -> 建立新档案，当前珠子即为该类永久基准
            new_id = self.create_cluster(lab_vector)
            return new_id
        else:
            return EXCEPTION_PORT
```

### 2.4 行业技术参考 (Industry Benchmarks)
本方案并非凭空臆造，而是参考了成熟工业设备的算法逻辑并进行了低成本化改良。

| 参考设备 | 核心原理 | 借鉴点 |
| :--- | :--- | :--- |
| **色选机 (Color Sorter)** | **原理**: 高速线阵相机 + FPGA 硬件阈值对比。<br>**特点**: 极快，但仅能分“好/坏”两类，无法应对未知颜色。 | **借鉴其“背景设计”**: 采用深色背景突出物料。<br>**借鉴其“拒识逻辑”**: 通过面积判断排除碎片干扰。 |
| **珠宝分级仪 (Sarine)** | **原理**: 积分球漫反射照明 + 分光光度计。<br>**特点**: 精度极高，但设备昂贵且只能单颗静态测量。 | **借鉴其“白平衡”**: 引入标准白卡校准流程。<br>**借鉴其“采样策略”**: 仅取物体中心最纯净区域颜色，避开边缘。 |

---

## 3. 软硬件集成架构 (System Integration)

### 3.1 相机 -> 程序 (Input)
为了满足流水线的高速实时性，**严禁使用读写硬盘文件**的方式传输图片。

| 环节 | 推荐方案 | 说明 |
| :--- | :--- | :--- |
| **触发信号** | **硬件硬触发 (Hardware Trigger)** | 光电开关检测到珠子瞬间，直接通过信号线触发相机抓拍，延迟微秒级。 |
| **数据传输** | **厂商 SDK (Callback模式)** | 使用工业相机 SDK (如 Hikvision MVS, Balser Pylon)，图像直接以内存 Buffer (Numpy Array) 形式送入算法，**零拷贝，零IO**。 |
| **物理接口** | **GigE Vision (网口) / USB3.0** | **GigE (网线)**：传输距离远(100m)，稳定性高，通过交换机或直连电脑网口通信。<br>**USB3.0**：带宽更高但线缆短(<5m)，适合紧凑型设备。 **推荐优先选 GigE**。 |

### 3.2 程序 -> 分拣机 (Output)
视觉程序完成计算后，需要将“分类结果”传给下位机执行机构（PLC 或 单片机）。

-   **方案 A (推荐): Modbus TCP / Socket**
    -   程序通过网线将 `Category_ID` 发送给 PLC。
    -   **优势**: 适合有 PLC 控制传送带的场景，PLC 负责根据皮带速度计算延迟，精准控制气枪吹气时间。
-   **方案 B (低成本): IO 板卡 / 串口**
    -   程序通过 USB 转 GPIO 板卡或者串口 (RS485)，直接输出高低电平控制继电器/电磁阀。
    -   **优势**: 结构简单，适合低速、无需复杂同步的小型设备。

---

## 4. 工程实施必要条件 (Prerequisites)

为确保算法准确性，现场物理环境**必须**满足以下标准，否则方案不可行。

| 维度 | 重要指数 | 要求 | 原因 |
| :--- | :--- | :--- | :--- |
| **相机机位** | ⭐⭐⭐⭐⭐ | **刚性固定**，垂直俯拍 90° | 避免透视畸变，确保像素/面积比一致。 |
| **拍摄参数** | ⭐⭐⭐⭐⭐ | **锁定白平衡 (Lock AWB)** & 锁定曝光 | 严禁使用手机“自动模式”，防止算法输入源被篡改。 |
| **光源环境** | ⭐⭐⭐⭐⭐ | **CRI>90 高显指 LED** + **遮光罩** | 保证颜色还原真实，杜绝自然光/频闪干扰。 |
| **校准流程** | ⭐⭐⭐⭐⭐ | **必备标准白卡** | 每次开机必须通过拍摄白卡校准，作为系统基准零点。 |
| **背景材质** | ⭐⭐⭐⭐ | **哑光黑 / 中性灰** (推荐) | 提高对比度，减少环境漫反射对珠子边缘颜色的污染。<br>*(注：若使用白底需满足特定条件，详见备注)* |

> **备注：关于背景颜色的选择**
> 1.  **首选深色 (黑/灰)**：吸光性好，能还原半透明玉石的真实“体色”，且易于分割浅色珠子。
> 2.  **慎用白色**：白底会产生漫反射照亮珠子底部，导致颜色变浅/失真；且若物料中包含白色/米色珠子，会因对比度不足导致无法识别（“隐身”）。若必须使用白底（如现有传送带限制），需确保物料无浅色系，并接受一定的颜色偏差。

---

## 4. 风险评估与应对 (Risk Analysis)

### 4.1 算法与视觉风险
| 风险点 | 风险描述 | 应对策略 |
| :--- | :--- | :--- |
| **高光干扰** | 玉石/玻璃珠表面反光强烈，导致提取到的颜色发白。 | **硬件**: 镜头加装 **CPL 偏振镜**。<br>**软件**: 算法仅采用珠子圆心 40% 区域的颜色均值。 |

### 4.2 落地与工程风险 (Operational Risks)
| 风险点 | 风险描述 | 应对策略 |
| :--- | :--- | :--- |
| **连料/重叠 (Double Feeding)** | 两颗珠子挨得太近或粘连，被当作一颗处理，或者第二颗来不及触发分选。 | **震动盘调优**: 调整送料速度，确保珠子间距 > 5cm。<br>**算法拒识**: 检测到面积过大(>1.5倍)的物体直接归入异常口，宁可漏过不可错分。 |
| **执行延迟 (Timing Latency)** | 视觉算好了，但信号发给 PLC 晚了 10ms，导致气枪吹气时珠子已经跑过了。 | **系统优化**: 确保算法耗时 < 20ms (仅计算 ROI 区域)。<br>**下位机补偿**: PLC 根据编码器实时计算位置，而非仅仅依赖时间延时。 |
| **镜头/背景脏污** | 工厂粉尘大，长期运行导致镜头蒙灰或背景板变脏，导致颜色整体发暗/误判。 | **自清洁**: 镜头前加装风刀(Air Knife)持续吹气防尘。<br>**强制重校**: 设定每 4 小时强制停机请求拍摄白卡校准。 |
| **机械误分 (Bouncing)** | 气枪吹气力度不稳，或者珠子撞到边缘弹跳进错误的料斗。 | **结构设计**: 料斗边缘增加软胶缓冲；定期检查气路气压稳定性。 |

---

## 5. 备选方案对比 (Alternatives)

### 备选方案 A：深度学习 (CNN Embedding)
-   **原理**: 使用 ResNet/MobileNet 提取特征向量，再计算余弦相似度。
-   **优点**: 抗干扰极强，不仅看颜色，还能看纹理（如区分“带花纹的绿”和“纯绿”）。
-   **缺点**: 需要 GPU 算力（成本高）；对于纯色珠子，效果未必比 LAB 聚类好（杀鸡用牛刀）。
-   **结论**: **暂不推荐**。除非后期发现仅靠颜色无法区分（如纹理分类需求）。

### 备选方案 B：传统色选机逻辑 (HSV 静态阈值)
-   **原理**: 预先由人工设定好“H:40-60是绿”，“H:100-120是蓝”。
-   **优点**: 逻辑极其简单，极其稳定，永远不会“漂移”。
-   **缺点**: **无法应对未知类别**。每当有新货，必须停机由工程师重写代码/配置参数。
-   **结论**: **不符合“动态发现”的业务需求**。

---

## 6. 最小成本验证建议 (MVP Path)

在采购专业工业相机之前，建议先通过手头设备完成 **“算法逻辑验证”**。

### 6.1 验证方案：手机 + Scrcpy
利用安卓手机作为临时图像采集终端，电脑端通过 ADB 实时获取屏幕画面。

-   **硬件连接**: 安卓手机通过 USB 连接电脑，开启“开发者模式”及“USB调试”。
-   **软件工具**: 使用开源软件 `scrcpy` 将手机屏幕投屏到电脑，Python 程序截取投屏窗口或直接读取 ADB 流。
-   **验证目标**: 跑通【拍照 -> 识别 -> 归类 -> 统计】的全流程软件逻辑。

> **⚠️ 注意事项**:
> 手机相机通常无法完全关闭“自动白平衡”和“自动曝光”。**验证结果仅代表逻辑可行性，不可作为最终颜色精度的参考**。正式上线必须换用工业相机。

---

## 7. 结论 (Conclusion)

基于 **增量式 LAB 聚类** 的方案在理论和工程上均 **具备高度可行性**。
-   **逻辑严密性**: 通过引入 **白平衡校准** 和 **中心加权采样**，解决了最大痛点（环境与反光干扰）。
-   **业务契合度**: 完美适配“不知道有多少种颜色”的动态场景。
-   **成本可控**: 无需昂贵 GPU，常规工控机即可运行。

**建议**:
立即启动 MVP 开发，按第 3 节要求搭建简易物理环境进行算法验证。
